-- Initialize ESP as off by default
local toggleESP = false  

-- Table to keep track of ESP lines for each player
local playerCubes = {}

-- Function to create a new cube for ESP
local function createCube()
    local lines = {}
    for i = 1, 12 do
        local line = Drawing.new("Line")
        line.Visible = false
        line.Thickness = 2
        line.Transparency = 0.85
        table.insert(lines, line)
    end
    return lines
end

-- Function to determine player color based on team or rainbow cycle
local function getPlayerColor(player)
    return player.Team and player.TeamColor.Color or getRainbowColor()
end

-- Function to create and update the cube for each player
local function updateCube(player)
    if not toggleESP then return end -- Do nothing if ESP is turned off
    
    local character = player.Character
    local rootPart = character and character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end

    local camera = game.Workspace.CurrentCamera
    local size = Vector3.new(1.5, 3, 1.5)
    local corners = {
        rootPart.CFrame * CFrame.new(-size.X, -size.Y, -size.Z),
        rootPart.CFrame * CFrame.new(size.X, -size.Y, -size.Z),
        rootPart.CFrame * CFrame.new(size.X, -size.Y, size.Z),
        rootPart.CFrame * CFrame.new(-size.X, -size.Y, size.Z),
        rootPart.CFrame * CFrame.new(-size.X, size.Y, -size.Z),
        rootPart.CFrame * CFrame.new(size.X, size.Y, -size.Z),
        rootPart.CFrame * CFrame.new(size.X, size.Y, size.Z),
        rootPart.CFrame * CFrame.new(-size.X, size.Y, size.Z),
    }

    local edges = {
        {1, 2}, {2, 3}, {3, 4}, {4, 1},
        {5, 6}, {6, 7}, {7, 8}, {8, 5},
        {1, 5}, {2, 6}, {3, 7}, {4, 8}
    }

    local color = getPlayerColor(player)  -- Dynamic color update

    for i, edge in pairs(edges) do
        local cubeLines = playerCubes[player]
        if cubeLines then
            local fromCorner, toCorner = corners[edge[1]].Position, corners[edge[2]].Position
            local screenPosA, onScreenA = camera:WorldToViewportPoint(fromCorner)
            local screenPosB, onScreenB = camera:WorldToViewportPoint(toCorner)

            if onScreenA and onScreenB then
                cubeLines[i].From = Vector2.new(screenPosA.X, screenPosA.Y)
                cubeLines[i].To = Vector2.new(screenPosB.X, screenPosB.Y)
                cubeLines[i].Color = color
                cubeLines[i].Visible = true
            else
                cubeLines[i].Visible = false
            end
        end
    end
end

-- Function to clean up ESP for a player who leaves or when toggling off
local function cleanupPlayer(player)
    local cubeLines = playerCubes[player]
    if cubeLines then
        for _, line in pairs(cubeLines) do
            line.Visible = false
            line:Remove()
        end
        playerCubes[player] = nil
    end
end

-- Function to refresh ESP for all players
local function refreshESP()
    -- Remove ESP cubes for any players who are no longer in the game
    for player, _ in pairs(playerCubes) do
        if not game.Players:FindFirstChild(player.Name) then
            cleanupPlayer(player)
        end
    end
    
    -- Update or create ESP cubes for each player in the game
    for _, player in pairs(game.Players:GetPlayers()) do
        if not playerCubes[player] and toggleESP then
            playerCubes[player] = createCube()
        end
        updateCube(player)
    end
end

-- Event listener for when a new player joins
game.Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        if not playerCubes[player] and toggleESP then
            playerCubes[player] = createCube()
        end
    end)
end)

-- Event listener for when a player leaves
game.Players.PlayerRemoving:Connect(function(player)
    cleanupPlayer(player)
end)

-- Toggle ESP on and off with the "Q" key
game:GetService("UserInputService").InputBegan:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.Q then
        toggleESP = not toggleESP
        -- Hide all ESP lines if turning off
        if not toggleESP then
            for player, _ in pairs(playerCubes) do
                cleanupPlayer(player)
            end
        end
    end
end)

-- Helper function for rainbow color (cycles every 5 seconds)
local function getRainbowColor()
    local hue = tick() % 5 / 5
    return Color3.fromHSV(hue, 1, 1)
end

-- Set up a recurring task to refresh ESP every 5 seconds
game:GetService("RunService").RenderStepped:Connect(function()
    if toggleESP then
        refreshESP()
    end
end)

